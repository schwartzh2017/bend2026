# Home Page Dashboard Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a home page at `/` with 4 summary cards: countdown, upcoming events, user balance, and recent groceries.

**Architecture:** Server Component page that fetches data server-side from Supabase. Reusable card components for each section. Mobile-first, PNW aesthetic following frontend-design.md skill.

**Tech Stack:** Next.js App Router, TypeScript, Tailwind CSS, Supabase

---

## Task 1: Create HomeCard Reusable Component

**Files:**
- Create: `components/HomeCard.tsx`

**Step 1: Create HomeCard component**

```tsx
import Link from 'next/link'

type Props = {
  title: string
  href: string
  children: React.ReactNode
}

export default function HomeCard({ title, href, children }: Props) {
  return (
    <Link href={href} className="block">
      <div
        className="border p-5 transition-all hover:-translate-y-0.5"
        style={{
          backgroundColor: 'var(--bg-card)',
          borderColor: 'var(--border)',
          boxShadow: '2px 3px 12px var(--shadow)',
        }}
      >
        <h2
          className="font-[family-name:var(--font-tenor)] text-xs uppercase tracking-wider mb-3"
          style={{ color: 'var(--text-muted)' }}
        >
          {title}
        </h2>
        {children}
      </div>
    </Link>
  )
}
```

**Step 2: Commit**

```bash
git add components/HomeCard.tsx
git commit -m "add HomeCard reusable component"
```

---

## Task 2: Create CountdownCard Component

**Files:**
- Create: `components/CountdownCard.tsx`

**Step 1: Create CountdownCard component**

```tsx
import HomeCard from './HomeCard'

type Props = {
  tripStartDate: string | null
}

function formatCountdown(targetDate: Date): string {
  const now = new Date()
  const diff = targetDate.getTime() - now.getTime()

  if (diff <= 0) {
    return 'Trip in progress!'
  }

  const days = Math.floor(diff / (1000 * 60 * 60 * 24))
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))

  if (days === 0) {
    return `${hours} hour${hours !== 1 ? 's' : ''}`
  }

  if (hours === 0) {
    return `${days} day${days !== 1 ? 's' : ''}`
  }

  return `${days} day${days !== 1 ? 's' : ''}, ${hours} hour${hours !== 1 ? 's' : ''}`
}

export default function CountdownCard({ tripStartDate }: Props) {
  const content = tripStartDate
    ? formatCountdown(new Date(tripStartDate))
    : 'Date coming soon'

  return (
    <HomeCard title="Trip Countdown" href="/schedule">
      <p
        className="font-[family-name:var(--font-tenor)] text-3xl"
        style={{ color: 'var(--text-primary)' }}
      >
        {content}
      </p>
    </HomeCard>
  )
}
```

**Step 2: Commit**

```bash
git add components/CountdownCard.tsx
git commit -m "add CountdownCard component"
```

---

## Task 3: Create UpcomingEventsCard Component

**Files:**
- Create: `components/UpcomingEventsCard.tsx`

**Step 1: Create UpcomingEventsCard component**

```tsx
import HomeCard from './HomeCard'
import type { Event } from '@/lib/supabase/types'

type Props = {
  events: Event[]
}

const eventTypeColors: Record<string, string> = {
  travel: 'var(--accent-secondary)',
  activity: 'var(--accent-primary)',
  meal: 'var(--accent-warm)',
  free: 'var(--text-muted)',
  lodging: 'var(--accent-gold)',
}

export default function UpcomingEventsCard({ events }: Props) {
  if (events.length === 0) {
    return (
      <HomeCard title="Upcoming" href="/schedule">
        <p style={{ color: 'var(--text-muted)' }}>No events scheduled</p>
      </HomeCard>
    )
  }

  return (
    <HomeCard title="Upcoming" href="/schedule">
      <div className="space-y-3">
        {events.map((event) => {
          const time = new Date(event.starts_at).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'America/Los_Angeles',
          })
          const dotColor = eventTypeColors[event.event_type] ?? eventTypeColors.activity

          return (
            <div key={event.id} className="flex items-center gap-3">
              <div
                className="w-2 h-2 rounded-full flex-shrink-0"
                style={{ backgroundColor: dotColor }}
              />
              <time
                className="font-mono text-sm flex-shrink-0"
                style={{ color: 'var(--text-muted)' }}
              >
                {time}
              </time>
              <span
                className="font-[family-name:var(--font-baskerville)] truncate"
                style={{ color: 'var(--text-primary)' }}
              >
                {event.title}
              </span>
            </div>
          )
        })}
      </div>
    </HomeCard>
  )
}
```

**Step 2: Commit**

```bash
git add components/UpcomingEventsCard.tsx
git commit -m "add UpcomingEventsCard component"
```

---

## Task 4: Create BalanceCard Component

**Files:**
- Create: `components/BalanceCard.tsx`

**Step 1: Create BalanceCard component**

```tsx
import HomeCard from './HomeCard'

type Props = {
  personId: string | null
  personName: string | null
  balanceCents: number | null
}

function formatCurrency(cents: number): string {
  const dollars = Math.abs(cents) / 100
  return dollars.toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
  })
}

export default function BalanceCard({ personId, personName, balanceCents }: Props) {
  if (!personId) {
    return (
      <HomeCard title="Your Balance" href="/identify?returnUrl=/">
        <p style={{ color: 'var(--text-muted)' }}>Tap to identify yourself</p>
      </HomeCard>
    )
  }

  const isPositive = balanceCents !== null && balanceCents > 0
  const isNegative = balanceCents !== null && balanceCents < 0
  const isZero = balanceCents !== null && balanceCents === 0

  let displayText: string
  let textColor: string

  if (isZero) {
    displayText = 'All settled up'
    textColor = 'var(--text-secondary)'
  } else if (isPositive) {
    displayText = `You're owed ${formatCurrency(balanceCents!)}`
    textColor = 'var(--accent-primary)'
  } else if (isNegative) {
    displayText = `You owe ${formatCurrency(balanceCents!)}`
    textColor = 'var(--accent-warm)'
  } else {
    displayText = 'No expenses yet'
    textColor = 'var(--text-muted)'
  }

  return (
    <HomeCard title="Your Balance" href="/expenses/settle">
      <p
        className="font-[family-name:var(--font-tenor)] text-2xl"
        style={{ color: textColor }}
      >
        {displayText}
      </p>
    </HomeCard>
  )
}
```

**Step 2: Commit**

```bash
git add components/BalanceCard.tsx
git commit -m "add BalanceCard component"
```

---

## Task 5: Create GroceriesCard Component

**Files:**
- Create: `components/GroceriesCard.tsx`

**Step 1: Create GroceriesCard component**

```tsx
import HomeCard from './HomeCard'
import type { Tables } from '@/lib/supabase/types'

type GroceryItem = Tables<'grocery_items'>

type Props = {
  items: GroceryItem[]
}

export default function GroceriesCard({ items }: Props) {
  if (items.length === 0) {
    return (
      <HomeCard title="Groceries" href="/groceries">
        <p style={{ color: 'var(--text-muted)' }}>Grocery list is empty</p>
      </HomeCard>
    )
  }

  return (
    <HomeCard title="Groceries" href="/groceries">
      <div className="space-y-2">
        {items.map((item) => (
          <div
            key={item.id}
            className="flex items-center gap-2"
          >
            <span
              className="font-[family-name:var(--font-baskerville)]"
              style={{ color: 'var(--text-primary)' }}
            >
              {item.name}
            </span>
            {item.requested_by && (
              <span
                className="text-sm"
                style={{ color: 'var(--text-muted)' }}
              >
                ({item.requested_by})
              </span>
            )}
          </div>
        ))}
      </div>
    </HomeCard>
  )
}
```

**Step 2: Commit**

```bash
git add components/GroceriesCard.tsx
git commit -m "add GroceriesCard component"
```

---

## Task 6: Create Balance Calculation Utility

**Files:**
- Create: `lib/homePageData.ts`

**Step 1: Create server-side data fetching utility**

```ts
import { createServerSupabaseClient } from '@/lib/supabase/server'
import {
  calculateNetBalances,
  calculateExpenseShares,
  type ExpenseWithParticipants,
} from '@/lib/expenseLogic'
import type { Tables } from '@/lib/supabase/types'

export type HomePageData = {
  tripStartDate: string | null
  upcomingEvents: Tables<'events'>[]
  personId: string | null
  personName: string | null
  balanceCents: number | null
  recentGroceries: Tables<'grocery_items'>[]
}

export async function getHomePageData(personId: string | null): Promise<HomePageData> {
  const supabase = await createServerSupabaseClient()

  const [
    { data: configData },
    { data: eventsData },
    { data: expensesData },
    { data: participantsData },
    { data: peopleData },
    { data: groceriesData },
  ] = await Promise.all([
    supabase.from('app_config').select('trip_start_date').single(),
    supabase
      .from('events')
      .select('*')
      .gte('starts_at', new Date().toISOString())
      .order('starts_at', { ascending: true })
      .limit(3),
    supabase.from('expenses').select('*').order('date', { ascending: false }),
    supabase.from('expense_participants').select('*'),
    supabase.from('people').select('*'),
    supabase
      .from('grocery_items')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(3),
  ])

  const tripStartDate = configData?.trip_start_date ?? null
  const upcomingEvents = eventsData ?? []
  const recentGroceries = groceriesData ?? []

  let balanceCents: number | null = null
  let personName: string | null = null

  if (personId && expensesData && participantsData && peopleData) {
    const participantsByExpense = new Map<string, Tables<'expense_participants'>[]>()
    for (const p of participantsData) {
      const existing = participantsByExpense.get(p.expense_id) ?? []
      existing.push(p)
      participantsByExpense.set(p.expense_id, existing)
    }

    const expensesWithShares: ExpenseWithParticipants[] = expensesData.map((expense) => {
      const expenseParticipants = participantsByExpense.get(expense.id) ?? []
      const isLodging = expenseParticipants.some((p) => p.nights !== null)

      const nightsMap = isLodging
        ? new Map(expenseParticipants.map((p) => [p.person_id, p.nights ?? 0]))
        : null

      const participantIds = expenseParticipants.map((p) => p.person_id)

      const shares = calculateExpenseShares(
        expense.amount_cents,
        participantIds,
        expense.paid_by,
        isLodging,
        nightsMap
      )

      return {
        id: expense.id,
        title: expense.title,
        amountCents: expense.amount_cents,
        paidBy: expense.paid_by,
        category: expense.category,
        date: expense.date,
        participants: shares,
      }
    })

    const personIds = peopleData.map((p) => p.id)
    const balances = calculateNetBalances(expensesWithShares, personIds)
    const userBalance = balances.find((b) => b.personId === personId)
    balanceCents = userBalance?.amountCents ?? 0

    const person = peopleData.find((p) => p.id === personId)
    personName = person?.name ?? null
  }

  return {
    tripStartDate,
    upcomingEvents,
    personId,
    personName,
    balanceCents,
    recentGroceries,
  }
}
```

**Step 2: Commit**

```bash
git add lib/homePageData.ts
git commit -m "add home page data fetching utility"
```

---

## Task 7: Create Home Page

**Files:**
- Modify: `app/page.tsx`

**Step 1: Update home page to use card components**

```tsx
import { cookies } from 'next/headers'
import { LOCAL_STORAGE_KEYS } from '@/lib/constants'
import CountdownCard from '@/components/CountdownCard'
import UpcomingEventsCard from '@/components/UpcomingEventsCard'
import BalanceCard from '@/components/BalanceCard'
import GroceriesCard from '@/components/GroceriesCard'
import { getHomePageData } from '@/lib/homePageData'

export default async function Home() {
  const cookieStore = await cookies()
  const personId = cookieStore.get(LOCAL_STORAGE_KEYS.PERSON_ID)?.value ?? null

  const data = await getHomePageData(personId)

  return (
    <div className="min-h-screen" style={{ backgroundColor: 'var(--bg-primary)' }}>
      <div className="max-w-[680px] mx-auto p-4 space-y-4">
        <CountdownCard tripStartDate={data.tripStartDate} />
        <UpcomingEventsCard events={data.upcomingEvents} />
        <BalanceCard
          personId={data.personId}
          personName={data.personName}
          balanceCents={data.balanceCents}
        />
        <GroceriesCard items={data.recentGroceries} />
      </div>
    </div>
  )
}
```

**Step 2: Run typecheck**

```bash
npm run typecheck
```

Expected: No errors

**Step 3: Commit**

```bash
git add app/page.tsx
git commit -m "replace home page redirect with dashboard cards"
```

---

## Task 8: Verify and Finalize

**Step 1: Run linter**

```bash
npm run lint
```

Expected: No errors

**Step 2: Run typecheck**

```bash
npm run typecheck
```

Expected: No errors

**Step 3: Run build**

```bash
npm run build
```

Expected: Build succeeds

**Step 4: Commit (if any fixes needed)**

If any fixes were required during verification:

```bash
git add -A
git commit -m "fix home page type and lint issues"
```

---

## Summary

**Files Created:**
- `components/HomeCard.tsx` - Reusable card wrapper
- `components/CountdownCard.tsx` - Trip countdown display
- `components/UpcomingEventsCard.tsx` - Next 3 events
- `components/BalanceCard.tsx` - User balance or identify prompt
- `components/GroceriesCard.tsx` - Last 3 grocery items
- `lib/homePageData.ts` - Server-side data fetching

**Files Modified:**
- `app/page.tsx` - Dashboard with 4 cards

**Commits:** 8 total (one per task)
